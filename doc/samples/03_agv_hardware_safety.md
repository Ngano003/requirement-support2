# 無人搬送車 (AGV) フリート管理システム - 詳細要求仕様書 (Part 3/3)
# ドキュメントID: RSS-AGV-003
# タイトル: ハードウェア制御・安全機能仕様
# バージョン: 1.0.0

---

## 改版履歴

| 版数 | 日付 | 変更者 | 内容 |
| :--- | :--- | :--- | :--- |
| 0.1.0 | 2025-10-10 | 技研 次郎 | ハードウェア構成案作成 |
| 1.0.0 | 2025-12-20 | 佐藤 花子 | 初版リリース |

---

## 目次

1. ハードウェアアーキテクチャ
2. 安全機能 (Safety Functions)
    2.1. 非常停止回路
    2.2. 障害物検知エリア設定
    2.3. 速度監視
3. 駆動系制御
    3.1. モータードライバ仕様
    3.2. ブレーキ制御
4. 電源・バッテリー管理
5. メンテナンス・診断機能
6. 既知の制約事項

---

## 1. ハードウェアアーキテクチャ

### 1.1. メインコントローラ
- **CPU**: ARM Cortex-A72 Quad Core (Raspberry Pi 4 Compute Module 等価)
- **OS**: Linux (Real-time Preempt Patch適用推奨)
- **Interface**:
    - CAN Bus x2 (Drive Unit, BMS)
    - RS-485 x2 (LDS, RFID Reader)
    - GPIO x16 (Sensors, LEDs, Switches)

### 1.2. サブコントローラ (Safety PLC)
- **MCU**: Cortex-M4F (SIL3対応マイコン)
- **Role**: 非常停止ボタン、バンパーセンサーの監視、モーター電源リレーの直接遮断。
- **Watchdog**: メインコントローラのハングアップを監視し、異常時に強制停止させる。

---

## 2. 安全機能 (Safety Functions)

### 2.1. 非常停止回路 (E-Stop Loop)

車両の四隅に配置された非常停止ボタン（EMOスイッチ）は、ハードウェア的に直列接続（シリーズ）され、モーターなどの動力源のリレーを直接遮断する構成とする。ソフトウェアの介在なしに電源が落ちる設計としなければならない。

- **Input**: EMO Switch (NC接点)
- **Output**: Main Contactor Coil

### 2.2. 障害物検知エリア設定 (LDS Area)

LDS（LiDAR）には、走行速度に応じた複数の保護ゾーンを設定する。

1. **Slow Zone (Warning)**: 検出時、0.3m/s以下に減速。
2. **Stop Zone (Protection)**: 検出時、即時停止。

| Speed Scope | Stop Zone Distance | Slow Zone Distance |
| :--- | :--- | :--- |
| 0 - 0.3 m/s | 0.5m | 1.0m |
| 0.3 - 0.8 m/s | 1.0m | 2.0m |
| 0.8 - 1.2 m/s | 1.5m | 3.0m |

### 2.3. 速度監視ロジック (Speed Monitoring)

メインコントローラとは独立したサブコントローラが、エンコーダパルスを常時監視する。

**Req.Safe.005 速度超過検知**
- 制限速度（1.5 m/s）を超えた場合、100ms以内に非常停止を作動させなければならない。
- エンコーダのパルス計測周期: 50ms
- 平均化フィルタ: 4サンプル移動平均 (200ms遅延)
- リレー遮断遅延: 20ms

---

## 3. 駆動系制御

### 3.1. モータードライバ仕様
- BLDCモーター 200W x 2 (差動2輪駆動)
- 通信: CANOpen Profile 402
- 制御モード: Velocity Mode

### 3.2. ブレーキ制御
- 無励磁作動型電磁ブレーキ（電源OFFでロック）。
- 停止時は必ずロックすること。移動開始時にアンロックすること。

---

## 4. 電源・バッテリー管理 (BMS)

- **Type**: LiFePO4 (リン酸鉄リチウム) 24V 60Ah
- **通信**: RS-485 Modbus RTU

**Req.Pwr.010 充電シーケンス**
1. 充電端子接触検知
2. CC充電モード開始
3. CV充電モード移行
4. 満充電検知でCutoff

---

## 5. メンテナンス・診断機能

### 5.1. 診断モード (Diagnostic Mode)

工場出荷時検査や定期点検で使用する詳細診断モード。

**機能**:
- 各センサーの生値表示
- モーターの単体駆動テスト（インターロック無効化）
- エラーログの全ダンプ

**Req.Maint.001 診断モードへの遷移手順**

診断モードへは、以下の手順でのみ遷移可能とする。

1. メイン電源をOFFにする。
2. ハードウェアDIPスイッチ SW_2 を ON にする。
3. リモコンの「Enter」ボタンを押しながらメイン電源をONにする。
4. 起動後、画面に「Diagnosis」と表示される。

---

## 6. センサスペック詳細

### 6.1. 磁気ガイドセンサー
- 分解能: 10mm pitch
- 出力: 16bit Digital IO
- 設置高さ: 床面から 30mm

### 6.2. バンパースイッチ
- 接触圧: 5N で作動
- 応答速度: < 5ms

### 6.3. リモコン受信機
- 赤外線方式 (NECフォーマット)
- 受信コード表:
    - 0xA1: Start
    - 0xA2: Stop
    - 0xB0: Reset Error

---

## 7. 付録：配線図 (Wiring Diagram Overview)

(テキストによる簡易表現)

```
[Battery 24V]
  |
  +--[Main Fuse 50A]
       |
       +--[E-Stop Relay (RY1)] ----> [Motor Driver L]
       |                       ----> [Motor Driver R]
       |
       +--[DC-DC 5V/3A] -----------> [Raspberry Pi (Main CPU)]
       |
       +--[DC-DC 12V/1A] ----------> [LDS Sensor]
                                   > [Magnetic Sensor]
```

---
(Part 3 終了)
