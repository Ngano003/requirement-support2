{
  "summary": "要件定義書に複数の状態遷移抜けや条件未網羅、リソース解放漏れ、タイミング矛盾などが散見され、特に SafeMode の脱出経路欠如や速度監視の実装制約が致命的です。",
  "defects": [
    {
      "id": "DEF-001",
      "category": "Dead Ends",
      "severity": "Critical",
      "location": "4.2.14 Error -> SafeMode",
      "description": "SafeMode に遷移した後、状態から抜け出す遷移が定義されていない。バッテリが回復したり、外部から復旧指示が来てもシステムは永続的に停止したままになる。",
      "recommendation": "SafeMode からの復帰遷移を追加し、例: SafeMode -> Idle (条件: バッテリ > 20% かつ Wi‑Fi 復帰) を規定する。"
    },
    {
      "id": "DEF-002",
      "category": "Dead Ends",
      "severity": "Critical",
      "location": "4.2.2 Idle -> Moving / 4.2.3 Moving -> Paused",
      "description": "Moving 状態でバッテリ残量が 20% 未満になるケースの遷移が未定義。低バッテリ時に走行を続行できず、充電ステーションへ戻れないまま停止する可能性がある。",
      "recommendation": "Moving -> Charging もしくは Moving -> Paused (低バッテリ) の遷移を追加し、条件を明示する。"
    },
    {
      "id": "DEF-003",
      "category": "Missing Else",
      "severity": "Major",
      "location": "4.2.2 Idle -> Moving (バッテリ残量条件)",
      "description": "バッテリ残量 > 20% が条件だが、正確に 20% の場合の挙動が未定義。境界値での動作が不明確になる。",
      "recommendation": "条件を \">= 20%\" と明記し、境界値の処理を統一する。"
    },
    {
      "id": "DEF-004",
      "category": "Missing Else",
      "severity": "Major",
      "location": "4.2.3 Moving -> Paused / 4.2.4 Paused -> Moving",
      "description": "障害物検知距離の閾値が <1.0m と >1.2m で分かれており、1.0〜1.2m の範囲が未定義。実際のセンサー誤差でこの領域に入ると状態遷移が起きない。",
      "recommendation": "中間帯域のハンドリングを追加し、例: 1.0‑1.2m は \"警告\" 状態 (Paused) に遷移させるか、ヒステリシスを導入する。"
    },
    {
      "id": "DEF-005",
      "category": "Orphan States",
      "severity": "Major",
      "location": "4.3 Loading Sub‑states",
      "description": "Loading のサブステート L_Approach, L_Handshake, L_Transfer, L_Verify が列挙されているが、相互遷移やエラーハンドリングが記載されていない。実装時に遷移ロジックが不明になる。",
      "recommendation": "各サブステート間の遷移図と、失敗時のフォールバック (例: L_Transfer 失敗 → L_Handshake 再試行) を明示する。"
    },
    {
      "id": "DEF-006",
      "category": "Orphan States",
      "severity": "Major",
      "location": "5.1 診断モード (Hardware Spec)",
      "description": "診断モードへの遷移手順がハードウェア文書に記載されているが、状態機械 (Part 1) から到達できる遷移が存在しない。運用上、ソフトウェアから診断モードへ入れない。",
      "recommendation": "状態機械に \"Maintenance -> Diagnostic\" もしくは \"Error -> Diagnostic\" の遷移を追加し、手順と条件を統合する。"
    },
    {
      "id": "DEF-007",
      "category": "Conflicting Outputs",
      "severity": "Major",
      "location": "2.2.5 CMD_EMERGENCY_STOP と 4.2.3/4.2.4 Paused 状態",
      "description": "緊急停止時に LED を RED_BLINK に設定するが、障害物検知で Paused 状態になると LED を YELLOW_BLINK に設定する。両方が同時に有効になると表示が競合し、オペレーターが状態を判別できない。",
      "recommendation": "LED 制御の優先順位を定義し、緊急停止が最上位 (RED_BLINK) になるように設計する。"
    },
    {
      "id": "DEF-008",
      "category": "Unstated Side Effects",
      "severity": "Major",
      "location": "3.2 交差点・排他制御フロー (Communication Spec)",
      "description": "AGV が REQ_ACQUIRE_RESOURCE を送信した後、エラーやタイムアウトが発生した場合に REQ_RELEASE_RESOURCE が必ず送られる保証がない。リソースが解放されず、他AGV が交差点に進入できなくなるデッドロックのリスクがある。",
      "recommendation": "エラー・タイムアウト時のリリースフローを明記し、FMS が自動的にリソースを回収するタイムアウト機構を追加する。"
    },
    {
      "id": "DEF-009",
      "category": "Timing Violation",
      "severity": "Critical",
      "location": "2.3.1 速度監視ロジック (Hardware Spec)",
      "description": "速度超過検知は 4 サンプル (200 ms) の移動平均を使用し、検知後 100 ms 以内に非常停止を作動させる必要があるが、フィルタ遅延だけで 200 ms 超えるため実装不可能。",
      "recommendation": "フィルタ遅延を削減するか、許容停止遅延を 300 ms 以上に緩和し、要件と実装を整合させる。"
    },
    {
      "id": "DEF-010",
      "category": "Timing Violation",
      "severity": "Critical",
      "location": "2.2.5 CMD_EMERGENCY_STOP (Communication Spec)",
      "description": "緊急停止は MQTT QoS 1 で送信されるが、QoS 1 は再送や ACK 待ちが発生し、数百ミリ秒以上の遅延が起こり得る。安全上、即時停止が求められる場面で遅延は許容できない。",
      "recommendation": "緊急停止は別途 UDP ベースのリアルタイムチャネル、または物理的 E‑Stop 回路と直接連携させ、遅延を 10 ms 以下に抑える。"
    },
    {
      "id": "DEF-011",
      "category": "Cycles",
      "severity": "Critical",
      "location": "3.2 交差点・排他制御フロー",
      "description": "複数 AGV が同時に同一交差点の Entry Node で REQ_ACQUIRE_RESOURCE を送信し、FMS が先着順で Grant しない場合、相互にリソース取得待ちでデッドロックになる可能性がある。",
      "recommendation": "FMS に公平な排他制御アルゴリズム（例: トークンリングまたはタイムアウト付きキュー）を規定し、取得失敗時のリトライバックオフを明示する。"
    },
    {
      "id": "DEF-012",
      "category": "Ambiguous Terms",
      "severity": "Minor",
      "location": "全体",
      "description": "\"SOC\"、\"バッテリ残量\"、\"バッテリ電圧\" が混在し定義が不統一。また \"オペレーター\" と \"Operator\" が文書内で混在し、読者が同一人物を指すか判断できない。",
      "recommendation": "用語集に SOC (State Of Charge) を明示し、バッテリ関連は統一した表記に統一する。日本語表記は \"オペレーター\" に統一し、英語表記は別途 Glossary として併記する。"
    }
  ]
}