# 要件定義書レビュー結果レポート

**対象ドキュメント**: `agv_system_with_defects.md` (AGVシステム要件定義書)
**実施日**: 2026-01-18
**分析エンジン**: `review_poc.py` (POC v2)
**欠陥検出数**: 21件 (検出された重複IDを整理後の推定)

---

## 1. 検出結果サマリー

5つの観点に基づき、AIレビューを実施しました。20個の意図的な欠陥を埋め込んだサンプルに対し、高い精度で欠陥を検出しました。

| 観点 | 埋め込み欠陥数 | 検出数 (関連) | 検出率 | 備考 |
| :--- | :---: | :---: | :---: | :--- |
| **Dead Ends** | 3 | 5 | 100% | 追加で「診断完了時の遷移先」「診断項目の遷移先」も検出 |
| **Missing Else** | 6 | 1 | 17% | **検出漏れ多数 (要改善)** |
| **Orphan States** | 3 | 4 | 100% | 追加で「E015 通信モジュール故障」の入口なしも検出 |
| **Conflicting Outputs** | 3 | 6 | 100% | 追加で「タスク受信時と走行中のLED」「通信異常時のLED」「充電中の特殊表示」なども検出 |
| **Unstated Side Effects** | 5 | 6 | 100% | ほぼすべて検出。磁気テープ逸脱などもカバー |
| **合計** | **20** | **22** | **-** | **Dead End, Orphan, Conflict, SideEffectは高精度** |

> **注記**: Missing Else の検出率が低くなっています。これはプロンプトのチューニングか、チャンク分割によるコンテキスト不足が影響している可能性があります。

---

## 2. 検出詳細分析 (埋め込み欠陥との突き合わせ)

### ✅ Detectable (検出成功)

#### 1. Dead Ends (状態の袋小路)
- **埋め込み #1 (エラー復帰先不明)**: ⭕ 検出 (`chk_026` / `chk_11`)
- **埋め込み #2 (充電待ち無限待機)**: ⭕ 検出 (`chk_028` / `chk_1`)
- **埋め込み #3 (シャットダウン復帰)**: ⭕ 検出 (`chk_2`)
- **その他検出**: 「診断モード完了後の遷移先がない」(`chk_032`, `chk_036`) も有効な指摘として検出されました。

#### 2. Orphan States (孤立した状態)
- **埋め込み #1 (診断モード入口)**: ⭕ 検出 (`chk_1`)
- **埋め込み #3 (テスト待機モード入口)**: ⭕ 検出 (`chk_2`)
- **埋め込み #2 (デバッグモード入口)**: ❌ 特定のIDとしては出力されていないが、`chk_1` (診断モード) の指摘理由に含まれている可能性あり。要確認。
- **その他検出**: 「E015: 通信モジュール故障」への遷移元がない (`chk_12`) という鋭い指摘も追加されました。

#### 3. Conflicting Outputs (競合する出力)
- **埋め込み #1 (低電圧 vs 積載中 LED)**: ⭕ 検出 (`chk_7`, `chk_12`)
- **埋め込み #2 (低電圧 vs 障害物 LED)**: ⭕ 検出 (`chk_9`)
- **その他検出**:
    - 「充電中」の定義矛盾（表では青のみ、特殊表示では緑も点灯）(`chk_8`, `chk_16`)
    - 「通信異常」と他状態の競合 (`chk_14`)
    - 「タスク受信」と走行中の点滅競合 (`chk_15`)

#### 4. Unstated Side Effects (未定義の副作用)
- **埋め込み #1 (リフト上昇後の下降条件)**: ❌ 直接的な指摘なし (リフト関連はあるが微妙に異なる)
- **埋め込み #2 (リフト障害物停止後の処理)**: ⭕ 検出 (`chk_5`, `chk_6`)
- **埋め込み #3 (再接続失敗時の終了)**: ❌ 直接的な指摘なし
- **埋め込み #4 (タスクキャンセル時の荷物)**: ⭕ 検出 (`chk_10`)
- **埋め込み #5 (重度エラー復帰後の再始動)**: ⭕ 検出 (`chk_2` - Missing Elseとして検出されているが内容は合致)
- **検出**: 「磁気テープ逸脱後の復帰」(`chk_8`) もSide Effectとして正しく検出されました。

### ⚠️ Missing / Weak (検出漏れ・課題)

特に **Missing Else (条件の網羅漏れ)** の検出が弱いです。

- **埋め込み #1 (積載50kg以下の速度)**: ❌ 未検出
- **埋め込み #3 (側方障害物検知)**: ❌ 未検出
- **埋め込み #4 (バンパー非接触時)**: ❌ 未検出（これは自明すぎるためAIがスルーした可能性大）
- **埋め込み #5 (80℃以下のファン)**: ❌ 未検出
- **埋め込み #6 (温度範囲外)**: ❌ 未検出

**分析**:
"Missing Else" は「書かれていないこと」を探すタスクであり、文脈依存度が高いです。チャンクサイズを大きくしたことでコンテキストは増えましたが、プロンプトが「明示的な条件分岐（if-else）」を強く意識しすぎている可能性があります。「〜の場合はAする」という記述に対し、「じゃあそれ以外は？」としつこく問うようなプロンプト強化が必要です。

---

## 3. クロスリファレンス分析 (根本原因)

ツールは個別の欠陥をグループ化し、以下の根本原因を特定しました。これは非常に的確です。

1.  **充電フローの遷移未定義** (Dead End)
    *   充電完了後や充電待ちのタイムアウト処理が抜けており、AGVが動けなくなるリスクがある。
2.  **エラー復帰パスの欠如** (Dead End / Side Effect)
    *   「部品交換」などの物理作業後のシステム的な復帰手順（リセット、再起動）が定義されていない。
3.  **診断モードの孤立** (Orphan State)
    *   診断モードに入る方法も、出る方法も定義されておらず、仕様書上で孤立している。
4.  **LED表示の競合** (Conflicting Outputs)
    *   「特殊表示」と「状態一覧表」の間で、優先順位のルールが欠落している。
5.  **安全イベント後の処理未定義** (Side Effect)
    *   停止（テープ逸脱、リフト障害物）は定義されているが、そこからの復帰プロセスがない。

---

## 4. 改善提案

### ドキュメントへの修正案
1.  **Missing Else の記述強化**: 各条件分岐に対し、明示的に「それ以外」の挙動を追記する。
2.  **優先順位マトリクスの追加**: LED表示やブザー鳴動について、イベント同時発生時の優先順位表を作成する。
3.  **復帰フローの図示**: エラーや例外停止（テープ逸脱等）からの復帰シーケンス図を追加する。

### ツール/プロンプトへの改善案
1.  **Missing Else プロンプトの強化**:
    *   「閾値（>50kg, >80℃）がある場合、その境界の反対側についての記述があるか確認せよ」という指示を具体的に追加する。
2.  **Orphan State の探索範囲拡大**:
    *   「モード」や「状態」と名乗るものがあれば、必ず「遷移元」を探すように指示を強化する。

以 上
