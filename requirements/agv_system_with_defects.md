# 自動倉庫搬送システム（AGV） 要件定義書

バージョン: 1.0  
作成日: 2026-01-18  

---

## 1. システム概要

### 1.1 目的
本システムは、倉庫内で荷物を自動搬送する無人搬送車（AGV: Automated Guided Vehicle）を制御するシステムである。
複数台のAGVを効率的に運用し、ピッキング作業の効率化を実現する。

### 1.2 適用範囲
- 倉庫内の通路を走行するAGV
- 棚との荷物の受け渡し
- 充電ステーションでの充電管理
- オペレータからの指示受付

### 1.3 用語定義

| 用語 | 説明 |
|------|------|
| AGV | Automated Guided Vehicle（無人搬送車 |
| ステーション | 荷物の積み下ろしを行う場所 |
| 充電ドック | AGVが充電を行う設備 |
| WMS | Warehouse Management System（倉庫管理システム） |
| タスク | AGVに割り当てられた搬送作業 |

---

## 2. 構成要素

### 2.1 ハードウェア構成

#### 2.1.1 AGV本体
- 最大積載重量: 100kg
- 最大走行速度: 1.5m/s
- バッテリー容量: 24V / 40Ah
- 駆動方式: 差動二輪駆動
- ガイド方式: 磁気テープ誘導 + レーザーセンサー

#### 2.1.2 センサー類
- レーザーセンサー（前方・後方）
- 超音波センサー（側面）
- バンパーセンサー（接触検知）
- 荷重センサー（積載検知）
- バッテリー電圧センサー
- 車輪エンコーダ（走行距離計測）

#### 2.1.3 アクチュエータ
- 走行モーター × 2
- リフトモーター × 1
- ブザー × 1
- LED表示灯（赤・黄・緑・青）

### 2.2 ソフトウェア構成

#### 2.2.1 中央制御サーバー
- タスク割り当てロジック
- 経路計算エンジン
- 交通管制システム
- WMS連携インターフェース

#### 2.2.2 AGV制御ソフトウェア
- 走行制御モジュール
- 障害物検知モジュール
- 通信モジュール
- 状態監視モジュール

---

## 3. 状態遷移

### 3.1 基本状態

AGVは以下の状態を持つ:

| 状態ID | 状態名 | 説明 |
|--------|--------|------|
| S01 | 待機 (Idle) | タスクを待っている状態 |
| S02 | 走行中 (Running) | 目的地に向かって移動中 |
| S03 | 積載中 (Loading) | 荷物を積み込んでいる状態 |
| S04 | 降載中 (Unloading) | 荷物を降ろしている状態 |
| S05 | 充電中 (Charging) | 充電ドックで充電中 |
| S06 | 一時停止 (Paused) | 何らかの理由で停止中 |
| S07 | 障害物停止 (Obstacle) | 障害物を検知して停止 |
| S08 | 緊急停止 (Emergency) | 緊急停止ボタン押下による停止 |
| S09 | メンテナンス (Maintenance) | 点検・整備中 |
| S10 | エラー (Error) | 異常発生による停止 |
| S11 | 充電待ち (ChargeQueue) | 充電ドック空き待ち状態 |
| S12 | 低電圧警告 (LowBattery) | バッテリー残量警告状態 |
| S13 | シャットダウン (Shutdown) | バッテリー枯渇による停止 |
| S14 | 自動復帰中 (Recovering) | エラーからの自動復帰処理中 |
| S15 | 診断モード (Diagnostic) | 自己診断実行中 |

### 3.2 状態遷移規則

#### 3.2.1 待機 (Idle) からの遷移

1. **タスク受信時**:
   - 中央サーバーからタスクを受信すると、「走行中 (Running)」に遷移する
   - LED表示灯を緑点灯に変更する

2. **充電指示時**:
   - バッテリー残量が30%以下になると、「走行中 (Running)」に遷移して充電ドックへ向かう

3. **緊急停止ボタン押下時**:
   - 「緊急停止 (Emergency)」に遷移する

#### 3.2.2 走行中 (Running) からの遷移

1. **目的地到達時（積載ステーション）**:
   - 積載ステーションに到達すると、リフトを上昇させ「積載中 (Loading)」に遷移する

2. **目的地到達時（降載ステーション）**:
   - 降載ステーションに到達すると、リフトを下降させ「降載中 (Unloading)」に遷移する

3. **障害物検知時**:
   - 前方2m以内に障害物を検知すると、走行を停止して「障害物停止 (Obstacle)」に遷移する
   - ブザーを短音2回鳴らす
   - LED表示灯を黄点滅に変更する

4. **バンパー接触時**:
   - バンパーセンサーが接触を検知すると、即座に走行を停止する
   - 「エラー (Error)」に遷移する
   - エラーコード: E001（接触エラー）を記録

5. **緊急停止ボタン押下時**:
   - 「緊急停止 (Emergency)」に遷移する

6. **バッテリー低下時**:
   - バッテリー残量が20%以下になると、ブザーを長音1回鳴らす

7. **充電ドック到達時**:
   - 充電ドックに到達すると、「充電中 (Charging)」に遷移する

#### 3.2.3 積載中 (Loading) からの遷移

1. **積載完了時**:
   - 荷重センサーが所定の重量を検知すると、「走行中 (Running)」に遷移する
   - 次の目的地（降載ステーション）へ向かう

2. **タイムアウト時**:
   - 60秒以内に積載が完了しない場合、ブザーを鳴らしてオペレータに通知する

3. **過積載検知時**:
   - 積載重量が100kgを超えた場合、「エラー (Error)」に遷移する
   - エラーコード: E002（過積載エラー）を記録
   - ブザーを連続音で鳴らす

#### 3.2.4 降載中 (Unloading) からの遷移

1. **降載完了時**:
   - 荷重センサーが0kgを検知すると、「待機 (Idle)」に遷移する
   - タスク完了を中央サーバーに報告する

2. **タイムアウト時**:
   - 60秒以内に降載が完了しない場合、ブザーを鳴らしてオペレータに通知する

#### 3.2.5 充電中 (Charging) からの遷移

1. **充電完了時**:
   - バッテリー残量が95%以上になると、充電を停止する

2. **緊急停止ボタン押下時**:
   - 「緊急停止 (Emergency)」に遷移する

3. **充電異常検知時**:
   - 充電電流が規定値を超えた場合、「エラー (Error)」に遷移する
   - エラーコード: E003（充電異常）を記録

#### 3.2.6 障害物停止 (Obstacle) からの遷移

1. **障害物除去時**:
   - 前方2m以内に障害物がなくなると、5秒後に「走行中 (Running)」に遷移する
   - LED表示灯を緑点灯に戻す

2. **待機時間超過時**:
   - 3分以上障害物が除去されない場合、経路再計算を要求する

3. **緊急停止ボタン押下時**:
   - 「緊急停止 (Emergency)」に遷移する

#### 3.2.7 緊急停止 (Emergency) からの遷移

1. **緊急停止解除時**:
   - オペレータが解除スイッチを操作すると、「待機 (Idle)」に遷移する
   - ただし、タスク実行中だった場合は「走行中 (Running)」に遷移してタスクを継続する

#### 3.2.8 メンテナンス (Maintenance) からの遷移

1. **メンテナンス完了時**:
   - 作業員が完了ボタンを押すと、自己診断を実行する
   - 診断結果が正常であれば「待機 (Idle)」に遷移する

2. **診断異常時**:
   - 自己診断で異常を検出した場合、「エラー (Error)」に遷移する

#### 3.2.9 エラー (Error) からの遷移

1. **自動復帰可能エラー時**:
   - エラーコードがE001〜E010の場合、「自動復帰中 (Recovering)」に遷移する

2. **手動復帰必要エラー時**:
   - エラーコードがE011以上の場合、オペレータの手動介入が必要
   - LED表示灯を赤点滅にする

<!-- 
【意図的な欠陥: Dead End #1】
手動復帰必要エラー時の「復帰先」が記載されていない。
オペレータが何をすればエラー状態から抜け出せるのか不明。
-->

#### 3.2.10 充電待ち (ChargeQueue) からの遷移

1. **充電ドック空き時**:
   - 充電ドックが空くと、「走行中 (Running)」に遷移してドックへ向かう

<!-- 
【意図的な欠陥: Dead End #2】
充電ドックが長時間空かない場合の対処が記載されていない。
AGVは無限に待ち続ける可能性がある。
-->

#### 3.2.11 低電圧警告 (LowBattery) 時の動作

1. **バッテリー残量20%以下**:
   - 現在のタスクを完了後、自動的に充電ドックへ向かう
   - LED表示灯を黄点灯にする

2. **バッテリー残量10%以下**:
   - 現在のタスクを中断し、即座に充電ドックへ向かう
   - ブザーを断続的に鳴らす

3. **バッテリー残量5%以下**:
   - その場で停止し、「シャットダウン (Shutdown)」に遷移する
   - すべてのモーターを停止する
   - LED表示灯を赤点灯にする

<!-- 
【意図的な欠陥: Dead End #3】
シャットダウン状態からの復帰方法が記載されていない。
バッテリーを充電しても、どうやって再起動するのか不明。
-->

#### 3.2.12 診断モード (Diagnostic) での動作

1. **診断項目**:
   - モーター動作確認
   - センサー較正
   - 通信テスト
   - バッテリー健全性チェック

2. **診断完了時**:
   - 結果を中央サーバーに送信する

<!-- 
【意図的な欠陥: Orphan State #1】
診断モードへの遷移方法が記載されていない。
この状態に入る手段が不明。
-->

---

## 4. LED表示灯仕様

### 4.1 LED状態一覧

| 状態 | 緑LED | 黄LED | 赤LED | 青LED |
|------|-------|-------|-------|-------|
| 待機中 | 点灯 | 消灯 | 消灯 | 消灯 |
| 走行中 | 点滅 | 消灯 | 消灯 | 消灯 |
| 積載/降載中 | 消灯 | 点灯 | 消灯 | 消灯 |
| 充電中 | 消灯 | 消灯 | 消灯 | 点灯 |
| 障害物検知 | 消灯 | 点滅 | 消灯 | 消灯 |
| エラー | 消灯 | 消灯 | 点滅 | 消灯 |
| 緊急停止 | 消灯 | 消灯 | 点灯 | 消灯 |
| 低電圧警告 | 消灯 | 点灯 | 消灯 | 消灯 |
| メンテナンス | 消灯 | 消灯 | 消灯 | 点滅 |

### 4.2 特殊表示

1. **通信異常時**:
   - 中央サーバーとの通信が5秒以上途絶えると、赤LEDと黄LEDを交互に点滅する

2. **タスク受信時**:
   - 新しいタスクを受信すると、緑LEDを3回高速点滅させる

3. **バッテリー充電中**:
   - 充電中は青LEDを点灯する
   - 充電残量に応じて緑LEDを点灯する（95%以上で点灯）

<!-- 
【意図的な欠陥: Conflicting Outputs #1】
「低電圧警告」時のLED（黄点灯）と「積載/降載中」のLED（黄点灯）が同じ。
低電圧状態で積載作業を行っている場合、どの表示を優先するか不明。
-->

4. **障害物検知中の低電圧警告**:
   - 障害物を検知中（黄点滅）にバッテリーが低下した場合、優先順位が未定義

<!-- 
【意図的な欠陥: Conflicting Outputs #2】
障害物検知（黄点滅）と低電圧警告（黄点灯）が同時発生した場合の対処が不明。
-->

---

## 5. ブザー仕様

### 5.1 ブザーパターン

| イベント | パターン | 説明 |
|----------|----------|------|
| タスク完了 | 短音1回 | タスクが正常に完了 |
| 障害物検知 | 短音2回 | 前方に障害物を検知 |
| 低電圧警告 | 長音1回 | バッテリー残量低下 |
| 過積載警告 | 連続音 | 積載重量超過 |
| タイムアウト | 短音3回 | 積載/降載タイムアウト |
| 緊急停止 | 連続音 | 緊急停止状態 |
| エラー発生 | 長音3回 | システムエラー発生 |

### 5.2 同時発生時の処理

<!-- 
【意図的な欠陥: Conflicting Outputs #3】
複数のブザーイベントが同時に発生した場合の優先順位が未定義。
例: 低電圧警告中に障害物を検知した場合、どのパターンを鳴らすか不明。
-->

---

## 6. 走行制御

### 6.1 速度制御

1. **通常走行時**:
   - 最大速度: 1.5m/s
   - 加速度: 0.5m/s²
   - 減速度: 0.8m/s²

2. **カーブ走行時**:
   - 最大速度: 0.8m/s
   - 曲率半径に応じて速度を自動調整

3. **障害物接近時**:
   - 前方5m以内に障害物を検知すると、速度を0.5m/sに減速する
   - 前方2m以内に障害物を検知すると、停止する

4. **積載時**:
   - 積載重量が50kgを超える場合、最大速度を1.0m/sに制限する

<!-- 
【意図的な欠陥: Missing Else #1】
積載重量が50kg以下の場合の速度制限が明示されていない。
50kg超過時は1.0m/s制限だが、50kg以下は1.5m/sに戻るのか、そのまま維持なのか不明。
-->

### 6.2 経路追従

1. **磁気テープ逸脱時**:
   - 逸脱を検知すると、即座に停止する

<!-- 
【意図的な欠陥: Missing Else #2】
磁気テープ逸脱後の復帰処理が記載されていない。
逸脱しなかった場合（正常追従時）の確認動作も不明。
-->

2. **交差点到達時**:
   - 中央サーバーからの指示を待つ
   - 指示を受信するまで一時停止する

### 6.3 衝突回避

1. **前方障害物検知時**:
   - レーザーセンサーで障害物を検知
   - 距離に応じて減速または停止

2. **側方障害物検知時**:
   - 超音波センサーで障害物を検知

<!-- 
【意図的な欠陥: Missing Else #3】
側方障害物を検知した場合の動作が記載されていない。
前方障害物では「減速または停止」だが、側方は検知するだけで何をするのか不明。
-->

---

## 7. リフト制御

### 7.1 リフト動作

1. **リフト上昇**:
   - 積載ステーション到達時にリフトを上昇させる
   - 上昇完了まで約3秒

2. **リフト下降**:
   - 降載ステーション到達時にリフトを下降させる
   - 下降完了まで約3秒

3. **リフト停止**:
   - 緊急停止時はリフトも即座に停止する

<!-- 
【意図的な欠陥: Unstated Side Effects #1】
リフトを上昇させた後、いつ下降させるかの条件が不完全。
降載ステーションでは下降するが、エラー発生時やタスクキャンセル時のリフト状態が不明。
-->

### 7.2 安全機構

1. **リフト上昇中の障害物検知**:
   - リフト上部に障害物を検知すると、上昇を停止する

2. **リフト下降中の障害物検知**:
   - リフト下部に障害物を検知すると、下降を停止する

<!-- 
【意図的な欠陥: Unstated Side Effects #2】
リフトが障害物検知で停止した後の処理が不明。
停止したまま待機するのか、自動的に逆方向に動くのか、アラームを出すのか未定義。
-->

---

## 8. 通信仕様

### 8.1 通信プロトコル

1. **使用プロトコル**: MQTT over TLS
2. **ブローカー**: 中央制御サーバー上で稼働
3. **通信周期**: 100ms

### 8.2 トピック構成

| トピック | 方向 | 内容 |
|----------|------|------|
| agv/{id}/status | AGV→Server | AGV状態報告 |
| agv/{id}/task | Server→AGV | タスク割り当て |
| agv/{id}/command | Server→AGV | 制御コマンド |
| agv/{id}/error | AGV→Server | エラー報告 |

### 8.3 通信異常時の動作

1. **通信途絶検知**:
   - 5秒以上サーバーからの応答がない場合、通信異常と判定する
   - 現在のタスクを一時停止する

2. **再接続処理**:
   - 2秒間隔で再接続を試行する
   - 再接続成功後、タスクを再開する

<!-- 
【意図的な欠陥: Unstated Side Effects #3】
再接続に失敗し続けた場合の終了条件が不明。
無限に再接続を試行し続けるのか、一定回数で諦めるのか未定義。
-->

3. **長期通信断時**:
   - 5分以上通信が復旧しない場合、安全な場所に移動して停止する

---

## 9. タスク管理

### 9.1 タスク種別

| タスクID | 種別 | 説明 |
|----------|------|------|
| T01 | 搬送 | A地点からB地点へ荷物を搬送 |
| T02 | 充電 | 充電ドックへ移動して充電 |
| T03 | 待機 | 指定位置で待機 |
| T04 | 退避 | 他AGVに道を譲るため退避 |

### 9.2 タスクキャンセル

1. **オペレータによるキャンセル**:
   - 管理画面からタスクをキャンセルできる
   - キャンセル時、AGVは現在位置で停止する

<!-- 
【意図的な欠陥: Unstated Side Effects #4】
タスクキャンセル時、積載中の荷物をどうするか記載がない。
荷物を積んだまま停止するのか、降載するのか不明。
-->

2. **システムによる自動キャンセル**:
   - バッテリー残量10%以下でタスクを自動キャンセル

### 9.3 タスク優先度

| 優先度 | 説明 |
|--------|------|
| 緊急 | 緊急搬送（人命に関わる物品など） |
| 高 | 出荷期限が迫っている荷物 |
| 中 | 通常の搬送タスク |
| 低 | 在庫整理などの補助タスク |

---

## 10. 安全機能

### 10.1 緊急停止

1. **緊急停止ボタン**:
   - AGV本体に設置された赤いボタンを押すと即座に停止
   - すべてのモーターを即時停止
   - 停止解除は手動操作が必要

2. **外部緊急停止**:
   - 中央サーバーから緊急停止コマンドを送信可能
   - 倉庫内の緊急停止スイッチ連動

### 10.2 接触検知

1. **バンパー接触時**:
   - 全方向のバンパーセンサーで接触を検知
   - 即座に走行を停止

<!-- 
【意図的な欠陥: Missing Else #4】
バンパー接触が「検知されなかった」場合の明示的な動作記述がない。
正常時の継続動作の確認条件が不明。
-->

### 10.3 過熱保護

1. **モーター過熱時**:
   - モーター温度が80℃を超えると、「一時停止 (Paused)」に遷移する
   - 冷却ファンを最大出力で稼働させる

<!-- 
【意図的な欠陥: Missing Else #5】
モーター温度が80℃以下の場合の冷却ファン動作が不明。
常時稼働なのか、条件動作なのか未定義。
-->

2. **冷却完了時**:
   - モーター温度が60℃以下になると走行を再開する

---

## 11. 保守モード

### 11.1 メンテナンスモード

1. **モード切替**:
   - 物理スイッチを「メンテナンス」位置に切り替える
   - この状態では自動運転は無効になる

2. **手動操作**:
   - リモコンでの手動走行が可能
   - リフトの手動上下操作が可能

### 11.2 デバッグモード

1. **機能**:
   - 詳細なセンサーログを出力する
   - 通信パケットのダンプが可能
   - モーターの個別テストが可能

2. **モード終了**:
   - 「終了」コマンドを送信すると通常モードに戻る

<!-- 
【意図的な欠陥: Orphan State #2】
デバッグモードへの遷移方法（入口）が記載されていない。
どうやってこのモードに入るのか不明。
-->

---

## 12. エラーコード一覧

### 12.1 軽度エラー（自動復帰可能）

| コード | 内容 | 復帰方法 |
|--------|------|----------|
| E001 | バンパー接触 | 5秒後自動復帰 |
| E002 | 過積載 | 荷物除去後自動復帰 |
| E003 | 充電異常 | 再接続で自動復帰 |
| E004 | 通信一時断 | 再接続で自動復帰 |
| E005 | センサー一時異常 | 自己診断で自動復帰 |

### 12.2 重度エラー（手動復帰必要）

| コード | 内容 | 復帰方法 |
|--------|------|----------|
| E011 | モーター故障 | 部品交換 |
| E012 | バッテリー異常 | バッテリー交換 |
| E013 | 制御基板異常 | 基板交換 |
| E014 | センサー永久故障 | センサー交換 |
| E015 | 通信モジュール故障 | モジュール交換 |

<!-- 
【意図的な欠陥: Unstated Side Effects #5】
重度エラーで部品交換後、システムをどうやって再始動するか記載がない。
単に電源を入れ直すだけで良いのか、初期化処理が必要なのか不明。
-->

---

## 13. 制約事項

### 13.1 運用制約

1. 同時稼働AGV台数: 最大50台
2. 最大通路幅: 3m
3. 最小通路幅: 1.5m
4. 床面傾斜: 3%以下

### 13.2 環境制約

1. 動作温度範囲: 5℃〜40℃
2. 動作湿度範囲: 20%〜80%（結露なきこと）
3. 照度: 100ルクス以上

<!-- 
【意図的な欠陥: Missing Else #6】
温度範囲外（5℃未満または40℃超過）の場合の動作が不明。
停止するのか、警告を出すのか、そのまま動くのか未定義。
-->

### 13.3 その他の制約

1. 連続稼働時間: 8時間以内（その後1時間の休止が必要）

---

## 14. インターフェース仕様

### 14.1 WMS連携

1. **タスク受信**:
   - WMSからの搬送依頼を受信
   - 依頼情報: 出発地、目的地、荷物ID、優先度

2. **状態報告**:
   - AGV位置情報を1秒間隔で報告
   - タスク完了/エラー発生時は即時報告

### 14.2 オペレータコンソール

1. **表示情報**:
   - 全AGVの現在位置をマップ上に表示
   - 各AGVの状態、バッテリー残量、現在タスクを表示

2. **操作機能**:
   - タスクの手動割り当て
   - AGVの緊急停止
   - メンテナンスモード切替

---

## 15. テスト待機モード (TestStandby)

### 15.1 概要
工場出荷前のテスト用モード。すべてのセンサーとアクチュエータを個別にテストできる。

### 15.2 機能
1. 各センサーの値をリアルタイム表示
2. 各モーターを個別に動作させる
3. LEDとブザーの動作確認
4. 通信テスト

### 15.3 終了時
テスト完了後、電源を切断する。

<!-- 
【意図的な欠陥: Orphan State #3】
テスト待機モードへの遷移方法が記載されていない。
どうやってこのモードに入るのか不明。
-->

---

## 付録A: 埋め込んだ欠陥の一覧（検証用）

| # | 観点 | 場所 | 説明 |
|---|------|------|------|
| 1 | Dead End | 3.2.9 | 手動復帰必要エラー時の復帰先が不明 |
| 2 | Dead End | 3.2.10 | 充電ドックが空かない場合の対処なし |
| 3 | Dead End | 3.2.11 | シャットダウンからの復帰方法なし |
| 4 | Orphan State | 3.2.12 | 診断モードへの遷移方法なし |
| 5 | Orphan State | 11.2 | デバッグモードへの遷移方法なし |
| 6 | Orphan State | 15 | テスト待機モードへの遷移方法なし |
| 7 | Missing Else | 6.1 | 積載重量50kg以下の速度制限不明 |
| 8 | Missing Else | 6.2 | 磁気テープ逸脱後の復帰処理なし |
| 9 | Missing Else | 6.3 | 側方障害物検知後の動作不明 |
| 10 | Missing Else | 10.2 | バンパー接触なし時の動作記述なし |
| 11 | Missing Else | 10.3 | 80℃以下の冷却ファン動作不明 |
| 12 | Missing Else | 13.2 | 温度範囲外の動作不明 |
| 13 | Conflicting Outputs | 4.2 | 低電圧と積載中のLED競合 |
| 14 | Conflicting Outputs | 4.2 | 障害物検知と低電圧のLED競合 |
| 15 | Conflicting Outputs | 5.2 | 複数ブザーイベントの優先順位未定義 |
| 16 | Unstated Side Effects | 7.1 | リフト上昇後の下降条件不完全 |
| 17 | Unstated Side Effects | 7.2 | リフト障害物停止後の処理不明 |
| 18 | Unstated Side Effects | 8.3 | 再接続失敗時の終了条件なし |
| 19 | Unstated Side Effects | 9.2 | タスクキャンセル時の荷物処理不明 |
| 20 | Unstated Side Effects | 12.2 | 重度エラー後の再始動方法なし |

---

<!-- 本文書は欠陥検出システムの検証用に作成されたサンプル文書です -->
