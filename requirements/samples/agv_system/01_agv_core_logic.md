# 無人搬送車 (AGV) フリート管理システム - 詳細要求仕様書 (Part 1/3)
# ドキュメントID: RSS-AGV-001
# タイトル: コアロジック・状態管理仕様
# バージョン: 1.0.0

---

## 改版履歴

| 版数 | 日付 | 変更者 | 内容 |
| :--- | :--- | :--- | :--- |
| 0.1.0 | 2025-10-01 | 山田 太郎 | 新規作成 |
| 0.5.0 | 2025-11-15 | 鈴木 一郎 | 状態遷移図の文字起こしを追加 |
| 1.0.0 | 2025-12-20 | 佐藤 花子 | 初版リリース |

---

## 目次

1. はじめに
2. システム概要
3. 用語定義
4. コアステートマシン (Main State Machine)
    4.1. 状態一覧
    4.2. 遷移条件詳細
    4.3. サブステート定義
5. ナビゲーションロジック (Navigation)
    5.1. 線追従アルゴリズム
    5.2. マーカー認識
    5.3. 交差点制御
6. 異常系処理 (Error Handling)
    6.1. エラーレベル定義
    6.2. リカバリフロー
    6.3. セーフモード

---

## 1. はじめに

### 1.1. 目的
本ドキュメントは、次世代物流センター向け無人搬送車（AGV: Automated Guided Vehicle）システムの、AGV単体の制御ロジック、特に状態遷移と自律走行の判断基準を定義するものである。

### 1.2. 適用範囲
本仕様は、AGVのファームウェアバージョン 2.X シリーズに適用される。
サーバー側（FMS）の仕様は `RSS-AGV-002`、ハードウェア制御の詳細は `RSS-AGV-003` を参照のこと。

---

## 2. システム概要

本AGVシステムは、磁気テープ誘導方式を採用し、床面のRFIDタグ（マーカー）によって絶対位置補正とコマンド実行を行う。
AGVは上位システム（FMS）からの指令に基づき、指定されたルートを走行し、荷物の積み下ろしを行う。

---

## 3. 用語定義

- **AGV (Automated Guided Vehicle)**: 無人搬送車本体。
- **FMS (Fleet Management System)**: 複数のAGVを管理・管制するサーバーシステム。
- **Node (ノード)**: 走行経路上に設置されたRFIDタグの位置。分岐点やステーションを示す。
- **Segment (セグメント)**: ノード間の走行パス。
- **LDS (Laser Distance Sensor)**: 障害物検知用のレーザーセンサー。
- **BMS (Battery Management System)**: バッテリー管理システム。

---

## 4. コアステートマシン (Main State Machine)

AGVの最上位の振る舞いは、以下のステートマシンによって管理される。

### 4.1. 状態一覧

| ID | 状態名 | 説明 |
| :--- | :--- | :--- |
| ST_001 | **Booting** | システム起動処理中。 |
| ST_002 | **Idle** | 待機状態。FMSからの指令待ち。 |
| ST_003 | **Moving** | 走行中。目的地へ向かっている。 |
| ST_004 | **Loading** | 荷積み作業中。詳細なサブステートを持つ。 |
| ST_005 | **Unloading** | 荷下ろし作業中。 |
| ST_006 | **Charging** | 充電中。充電ステーションに接続されている。 |
| ST_007 | **Paused** | 一時停止中。障害物検知などによる一時的な停止。 |
| ST_008 | **Error** | エラー発生中。オペレーターの介入が必要な場合がある。 |
| ST_009 | **Maintenance** | 保守モード。手動操作が可能。 |
| ST_010 | **SafeMode** | 重度障害時の縮退運転モード。 |

### 4.2. 遷移条件詳細

#### 4.2.1. Booting -> Idle
- **トリガー**: システム初期化完了 (Event_Init_Complete)
- **条件**: 自己診断 (POST) が全てのモジュールでPassであること。
- **アクション**: FMSへ「起動完了通知」を送信する。WiFi接続を確立する。

#### 4.2.2. Idle -> Moving
- **トリガー**: 搬送指示受信 (Event_Transport_Order)
- **条件**: バッテリー残量 (SOC) > 20% であること。現在位置が特定されていること。
- **アクション**: 経路計画をロードし、走行モーターを励磁する。

#### 4.2.3. Moving -> Paused
- **トリガー**: 障害物検知 (Event_Obstacle_Detected)
- **条件**: LDSの検知距離 < 1.0m が 300ms以上継続した場合。
- **アクション**: 減速停止。警告音鳴動。FMSへ「障害物検知」ステータスを送信。

#### 4.2.4. Paused -> Moving
- **トリガー**: 障害物除去 (Event_Obstacle_Cleared)
- **条件**: LDSの検知距離 > 1.2m が 2000ms以上継続したこと。
- **アクション**: 警告音停止。走行再開。

#### 4.2.5. Moving -> Loading
- **トリガー**: 積込ステーション到着 (Event_Arrived_Pickup)
- **条件**: 指定されたRFIDタグを読み取り、停止位置精度が±10mm以内であること。
- **アクション**: 移載装置との通信を開始する。

#### 4.2.6. Loading -> Moving
- **トリガー**: 積込完了 (Event_Load_Complete)
- **条件**: 荷物センサーがONであること。
- **アクション**: 次の目的地（荷下ろし場所）への経路を設定する。

#### 4.2.7. Moving -> Unloading
- **トリガー**: 荷下ろしステーション到着 (Event_Arrived_Dropoff)
- **条件**: 停止位置精度が±10mm以内であること。

#### 4.2.8. Unloading -> Idle
- **トリガー**: 荷下ろし完了 (Event_Unload_Complete)
- **条件**: 荷物センサーがOFFであること。
- **アクション**: 待機位置へ移動、もしくはその場でIdle遷移。

#### 4.2.9. Idle -> Charging
- **トリガー**: 充電指令 (Event_Go_Charge) または 低電圧検知 (Event_Low_Battery)
- **条件**: 充電ステーションが空いていること（FMS確認）。
- **アクション**: 充電ステーションへ移動し、ドッキングシーケンスを開始する。

#### 4.2.10. Charging -> Idle
- **トリガー**: 充電完了 (Event_Charge_Complete)
- **条件**: SOC > 95%。
- **アクション**: ドッキング解除シーケンスを実行する。

#### 4.2.11. Global -> Error
- **トリガー**: 重大エラー検知 (Event_Critical_Error)
- **説明**: どの状態からでも、センサー断線や通信タイムアウト(60秒)が発生した場合はError状態へ遷移する。

#### 4.2.12. Error -> Maintenance
- **トリガー**: モード切替スイッチ「MANUAL」 (Event_Switch_Manual)
- **条件**: 物理スイッチの変更を検知。
- **アクション**: サーボロック解除。

#### 4.2.13. Maintenance -> Idle
- **トリガー**: モード切替スイッチ「AUTO」 (Event_Switch_Auto)
- **条件**: エラーフラグがクリアされていること。
- **アクション**: 初期位置推定シーケンスを実行。

#### 4.2.14. Error -> SafeMode
- **トリガー**: ネットワーク切断かつバッテリー低下 (Event_NetLoss_LowBat)
- **条件**: WiFi RSSI < -80dBm かつ SOC < 15%。
- **アクション**: 全アクチュエータの電源遮断、位置情報の不揮発メモリへの退避、非常用ビーコンの点滅開始。
- **注記**: この状態はハードウェア保護のための最終防衛ラインである。

### 4.3. サブステート定義: Loading

Loading状態は内部に以下のサブステートを持つ。

1. **L_Approach**: ステーションへの精密アプローチ
2. **L_Handshake**: 地上設備とのI/Oハンドシェイク
3. **L_Transfer**: コンベア駆動中
4. **L_Verify**: 荷物着座確認

(詳細記述省略: 約50行相当の内容がここに含まれると仮定)

---

## 5. ナビゲーションロジック (Navigation)

### 5.1. 線追従アルゴリズム (Line Following)

磁気センサーアレイ（16bit）の入力値に基づき、ステアリング角度を計算する。

- 基本制御: PID制御
    - P項: 偏差 * Kp
    - I項: 偏差累積 * Ki
    - D項: 偏差変化率 * Kd
- 速度制御: カーブ検知時は自動減速する。

### 5.2. 交差点制御・分岐ロジック

ノード（RFID）検知時の分岐動作は以下のルールに従う。

**Req.Nav.005 分岐判断ロジック**
次の経路情報 `NextPath` が指示された場合：

1. `NextPath.Direction == LEFT` の場合：
    - 左側の磁気テープを優先して追従する。
    - 左ウインカーを点灯する。
    - 速度を0.3m/sに制限する。

2. `NextPath.Direction == RIGHT` の場合：
    - 右側の磁気テープを優先して追従する。
    - 右ウインカーを点灯する。
    - 速度を0.3m/sに制限する。

3. `NextPath.Direction == STRAIGHT` の場合：
    - 中央の磁気テープを維持する。
    - 分岐側のテープ入力をマスク（無視）する。
    - 速度変更なし。

---

### 5.3. マーカー処理仕様

RFIDタグから読み取ったデータ（TagID）に基づき、AGVは自身のアクションを決定する。

| Tag Type | Data Value | Action |
| :--- | :--- | :--- |
| TYPE_SPD | 0x01 (Low) | 速度を0.2m/sに設定 |
| TYPE_SPD | 0x02 (Mid) | 速度を0.5m/sに設定 |
| TYPE_SPD | 0x03 (High) | 速度を1.0m/sに設定 |
| TYPE_LOC | ZoneID | 現在位置座標の補正 |
| TYPE_CMD | 0x10 (Spin) | その場で180度旋回 |
| TYPE_CMD | 0x20 (Pause) | 3秒間一時停止 |

---

## 6. 異常系処理 (Error Handling)

### 6.1. エラーコード一覧

| Code | Level | Description |
| :--- | :--- | :--- |
| E_001 | Warning | 経路逸脱（軽微）。自動復帰試行。 |
| E_002 | Warning | WiFi信号強度低下。 |
| E_101 | Error | 障害物検知タイムアウト（5分経過）。 |
| E_102 | Error | 荷物移載失敗。 |
| E_201 | Critical | バッテリー電圧 危険域。 |
| E_202 | Critical | 磁気センサー全損。 |
| E_999 | Fatal | CPU例外発生。Watchdog Reset。 |

### 6.2. リカバリフロー

**Req.Err.010 経路逸脱時の復帰**
AGVが磁気テープを見失った場合（All Sensors OFF）、直前のステアリング角度を維持して最大50cmまで直進する。
それでも検知できない場合、 `State = Error` へ遷移し、音声ガイダンス「コースを外れました」を再生する。

**Req.Err.011 通信切断時の挙動**
FMSとのハートビートが途絶えた場合：
1. 即座に停止するのではなく、減速走行モードに移行。
2. 直近のRFIDタグ位置まで走行し、そこで待機（Idle遷移）。
3. 待機中に再接続を試みる。10分間再接続不可なら `State = Error` とする。

### 6.3. セーフモード (SafeMode) 詳細

前述 4.2.14 で定義された `SafeMode` は、バッテリーの完全放電を防ぎ、システムログを保護するための特殊状態である。

- **突入条件**:
    - バッテリー残量がシステム維持限界（15%）を下回る。
    - かつ、外部電源（充電器）に接続されていない。
    - かつ、上位通信が確立できず救援を呼べない。

- **動作詳細**:
    - 走行モーター電源リレー：OFF
    - センサー群電源：OFF
    - CPU：Deep Sleepモードへ移行
    - ビーコン：5秒間隔で赤点滅（専用サブマイコン制御）

---

## 7. 追加要件：ログ詳細

（紙幅の都合上、以下にログフォーマットの定義が続くが、本サンプルでは省略する。）

### 7.1. システムパラメータ一覧

| ID | Param Name | Default | Unit | Description |
| :--- | :--- | :--- | :--- | :--- |
| P_001 | VEL_MAX | 1000 | mm/s | 最高速度設定 |
| P_002 | VEL_ACC | 500 | mm/s2 | 加速度設定 |
| P_003 | VEL_DEC | 500 | mm/s2 | 減速度設定 |
| P_004 | TURN_SPEED | 300 | mm/s | 旋回時の速度 |
| P_005 | OBS_DETECT_DIST | 1500 | mm | 障害物検知開始距離 |
| P_006 | OBS_STOP_DIST | 500 | mm | 障害物停止距離 |
| P_007 | YAW_GAIN_P | 1.25 | - | 操舵PID Pゲイン |
| P_008 | YAW_GAIN_I | 0.05 | - | 操舵PID Iゲイン |
| P_009 | YAW_GAIN_D | 0.80 | - | 操舵PID Dゲイン |
| ... | ... | ... | ... | ... |
| P_050 | BAT_LOW_TH | 20 | % | 低電圧警告閾値 |
| P_051 | BAT_CRIT_TH | 10 | % | シャットダウン閾値 |

---

## 8. 付属資料

### 8.1. 関連規格
- JIS D 6802: 無人搬送車システム－安全通則
- ISO 13849-1: Safety of machinery

### 8.2. 注意事項
- 本AGVは屋内専用である。水濡れ厳禁。
- 斜度3度以上の坂道走行は不可。

（ドキュメント終了）
